<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Make debugging exciting and play music instead!">
  <meta name="author" content="Ryan Macdonald <macdonaldr93@gmail.com>">

  <title>console.song();</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="stylesheet" href="https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css">
  <style>
    .bg-animate,
    .bg-animate:hover,
    .bg-animate:focus {
      transition: background-color 100ms ease-in-out;
    }
  </style>
</head>

<body class="w-100 sans-serif bg-white">
  <div class="vh-100 dt w-100 tc bg-blue white cover bg-animate" id="Background" style="background-color: rgb(40, 203, 215);">
    <div class="dtc v-mid">
      <h1 class="f1 fw2 ttu tracked mb2 lh-title white-80">console.song();</h1>
      <h2 class="fw2 white-70">Open your console:
        <code>View > Developer > JavaScript Console</code>
      </h2>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <!-- Spotify Code -->
  <script>
    // Get the hash of the url
    const hash = window.location.hash
      .substring(1)
      .split('&')
      .reduce(function (initial, item) {
        if (item) {
          var parts = item.split('=');
          initial[parts[0]] = decodeURIComponent(parts[1]);
        }
        return initial;
      }, {});
    window.location.hash = '';

    // Set token
    let _token = hash.access_token || localStorage.getItem('token');
    if (hash.access_token) {
      localStorage.setItem('token', hash.access_token);
    }

    const authEndpoint = 'https://accounts.spotify.com/authorize';

    // Replace with your app's client ID, redirect URI and desired scopes
    const clientId = 'c8bf4325fa1d482cb618daee323dacab';
    const redirectUri = 'http://localhost:3000';
    const scopes = [
      'streaming',
      'user-read-birthdate',
      'user-read-email',
      'user-read-private'
    ];

    // If there is no token, redirect to Spotify authorization
    if (!_token) {
      window.location = `${authEndpoint}?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scopes.join('%20')}&response_type=token&show_dialog=true`;
    }

    // Set up the Web Playback SDK
    window.onSpotifyPlayerAPIReady = () => {
      const player = new Spotify.Player({
        name: 'console.song();',
        getOAuthToken: cb => {cb(_token);}
      });

      // Error handling
      player.on('initialization_error', e => console.error(e));
      player.on('authentication_error', e => {
        console.error(e);
        localStorage.removeItem('token');
      });
      player.on('account_error', e => console.error(e));
      player.on('playback_error', e => console.error(e));

      // Ready
      player.on('ready', (readyData) => {
        let currentTimeout;

        const deviceId = readyData.device_id;
        console.log('console.song(); is ready', deviceId);
        console.song = function (song, timer) {
          if (!timer) {
            timer = 10000;
          }

          if (currentTimeout) {
            clearTimeout(currentTimeout);
          }

          search(song)
            .then((data) => {
              const track = data.tracks.items[0].uri;
              play(track, deviceId);

              currentTimeout = setTimeout(() => {
                pause(deviceId);
              }, timer);
            });
        };

        console.pause = function () {
          if (currentTimeout) {
            clearTimeout(currentTimeout);
          }

          pause(deviceId);
        };
      });

      // Connect to the player!
      player.connect();
    }

    // Play a specified track on the Web Playback SDK's device ID
    function play(track, deviceId) {
      return new Promise((resolve, reject) => {
        $.ajax({
          url: "https://api.spotify.com/v1/me/player/play?device_id=" + deviceId,
          type: "PUT",
          data: JSON.stringify({"uris": [track]}),
          beforeSend: function (xhr) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + _token);
          },
          success: function (data) {
            resolve(data);
          },
        });
      });
    }

    function pause(deviceId) {
      return new Promise((resolve, reject) => {
        $.ajax({
          url: "https://api.spotify.com/v1/me/player/pause?device_id=" + deviceId,
          type: "PUT",
          beforeSend: function (xhr) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + _token);
          },
          success: function (data) {
            resolve(data);
          },
        });
      });
    }

    // Search for a song
    function search(query) {
      return new Promise((resolve, reject) => {
        $.ajax({
          url: "https://api.spotify.com/v1/search?type=track&limit=1&q=" + query,
          type: "GET",
          beforeSend: function (xhr) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + _token);
          },
          success: function (data) {
            resolve(data);
          },
        });
      });
    }
  </script>

  <!-- Color changing -->
  <script>
    var $el = $('#Background');

    var p_x, p_y,
      window_width = window.innerWidth,
      window_height = window.innerHeight;

    var m = {
      moving_left: false,
      moving_up: false,
      last_x: 0,
      last_y: 0,
      x: 0,
      y: 0
    };

    var colors = {
      orange: {r: 238, g: 119, b: 0},
      blue: {r: 40, g: 203, b: 215}
    };

    $el.on('mousemove', function (e) {
      m.x = e.pageX;
      m.y = e.pageY;

      m.moving_left = (m.x < m.last_x) ? true : false;
      m.moving_up = (m.y < m.last_y) ? true : false;

      m.last_x = m.x;
      m.last_y = m.y;

      var percentage = m.y / window_width;
      var col = 'rgb(' + getRed(percentage) + ',' + getGreen(percentage) + ',' + getBlue(percentage) + ')';

      $el.css('background-color', col);

    });

    function getRed(percentage) {
      var max = 238, min = 40;
      var range = max - min;
      return min + Math.floor(range * percentage);
    }

    function getGreen(percentage) {
      var max = 119, min = 203;
      var range = max - min;
      return min + Math.floor(range * percentage);
    }

    function getBlue(percentage) {
      var max = 0, min = 215;
      var range = max - min;
      return min + Math.floor(range * percentage);
    }
  </script>
</body>

</html>
